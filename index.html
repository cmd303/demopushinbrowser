<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Demopushinbrowser by cmd303</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Demopushinbrowser</h1>
      <h2 class="project-tagline"></h2>
      <a href="https://github.com/cmd303/demopushinbrowser" class="btn">View on GitHub</a>
      <a href="https://github.com/cmd303/demopushinbrowser/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/cmd303/demopushinbrowser/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
  <button class="js-push-button" disabled>
    Enable Push Messages
</button>
<script>
    window.addEventListener('load', function () {
        var pushButton = document.querySelector('.js-push-button');
        pushButton.addEventListener('click', function () {
            if (isPushEnabled) {
                unsubscribe();
            } else {
                subscribe();
            }
        });

        // Check that service workers are supported, if so, progressively  
        // enhance and add push messaging support, otherwise continue without it.  
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js')
            .then(initialiseState);
        } else {
            console.warn('Service workers aren\'t supported in this browser.');
        }
    });
    // Once the service worker is registered set the initial state  
    function initialiseState() {
        // Are Notifications supported in the service worker?  
        if (!('showNotification' in ServiceWorkerRegistration.prototype)) {
            console.warn('Notifications aren\'t supported.');
            return;
        }

        // Check the current Notification permission.  
        // If its denied, it's a permanent block until the  
        // user changes the permission  
        if (Notification.permission === 'denied') {
            console.warn('The user has blocked notifications.');
            return;
        }

        // Check if push messaging is supported  
        if (!('PushManager' in window)) {
            console.warn('Push messaging isn\'t supported.');
            return;
        }

        // We need the service worker registration to check for a subscription  
        navigator.serviceWorker.ready.then(function (serviceWorkerRegistration) {
            // Do we already have a push message subscription?  
            serviceWorkerRegistration.pushManager.getSubscription()
              .then(function (subscription) {
                  // Enable any UI which subscribes / unsubscribes from  
                  // push messages.  
                  var pushButton = document.querySelector('.js-push-button');
                  pushButton.disabled = false;

                  if (!subscription) {
                      // We aren't subscribed to push, so set UI  
                      // to allow the user to enable push  
                      return;
                  }

                  // Keep your server in sync with the latest subscriptionId
                  sendSubscriptionToServer(subscription);

                  // Set your UI to show they have subscribed for  
                  // push messages  
                  pushButton.textContent = 'Disable Push Messages';
                  isPushEnabled = true;
              })
              .catch(function (err) {
                  console.warn('Error during getSubscription()', err);
              });
        });
    }
    function subscribe() {
        // Disable the button so it can't be changed while  
        // we process the permission request  
        var pushButton = document.querySelector('.js-push-button');
        pushButton.disabled = true;

        navigator.serviceWorker.ready.then(function (serviceWorkerRegistration) {
            serviceWorkerRegistration.pushManager.subscribe()
              .then(function (subscription) {
                  // The subscription was successful  
                  isPushEnabled = true;
                  pushButton.textContent = 'Disable Push Messages';
                  pushButton.disabled = false;

                  // TODO: Send the subscription.endpoint to your server  
                  // and save it to send a push message at a later date
                  return sendSubscriptionToServer(subscription);
              })
              .catch(function (e) {
                  if (Notification.permission === 'denied') {
                      // The user denied the notification permission which  
                      // means we failed to subscribe and the user will need  
                      // to manually change the notification permission to  
                      // subscribe to push messages  
                      console.warn('Permission for Notifications was denied');
                      pushButton.disabled = true;
                  } else {
                      // A problem occurred with the subscription; common reasons  
                      // include network errors, and lacking gcm_sender_id and/or  
                      // gcm_user_visible_only in the manifest.  
                      console.error('Unable to subscribe to push.', e);
                      pushButton.disabled = false;
                      pushButton.textContent = 'Enable Push Messages';
                  }
              });
        });
    }
</script>
      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/cmd303/demopushinbrowser">Demopushinbrowser</a> is maintained by <a href="https://github.com/cmd303">cmd303</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>
  </body>
</html>
